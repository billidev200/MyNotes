# Metasploit

Open machines terminal&#x20;

```
shell
```

Go back to meterpreter

* ctrl + z to exit
* typing exit

**Linux**&#x20;

opens  better shell

```bash
/bin/bash -i 
```

* -i : interactive shell

**Windows**&#x20;

opens better shell

```
cmd.exe
```

## &#x20;üì∂ **Sessions Commands**

Send current session to background

```bash
background
```

| Command            | Description                                      | Example         |
| ------------------ | ------------------------------------------------ | --------------- |
| `sessions`         | List all active sessions.                        | `sessions`      |
| `sessions -i <id>` | Interact with a specific session.                | `sessions -i 1` |
| `sessions -k <id>` | Kill a specific session.                         | `sessions -k 1` |
| `sessions -K`      | Kill all sessions.                               | `sessions -K`   |
| `sessions -v`      | List verbose info about sessions.                | `sessions -v`   |
| `sessions -u <id>` | Upgrade a shell to Meterpreter.                  | `sessions -u 2` |
| `interact <id>`    | Interact with a session (same as `sessions -i`). | `interact 1`    |

## üì∂Upgrade Session

This commands upgrades to a meterpeter session

```
meterpeter> sessions -u <session_id>
```

## Autoroute

### üîÅ What is `autoroute`?

`autoroute` is a **Meterpreter post module** that adds routes to subnets accessible **only from the target machine**, allowing you to pivot through it and reach internal networks.

| Command                                  | Description                    |
| ---------------------------------------- | ------------------------------ |
| `run autoroute`                          | Loads autoroute module         |
| `run autoroute -s <subnet> -n <netmask>` | Adds a route to subnet         |
| `run autoroute -p`                       | Prints current routes          |
| `run autoroute -d <subnet>`              | Deletes a specific route       |
| `route`                                  | View Metasploit's route table  |
| `route add <subnet> <mask> <id>`         | Manually add route via session |

## Migrate

First we use ps command to see running services and choose

For highest privalege we choose **SYSTEM services also we downgrade to lower service with less permision we cant go back up**

{% hint style="warning" %}
Anything under `NT AUTHORITY\SYSTEM` is running as SYSTEM.
{% endhint %}

```
meterpeter> migrate <PID>
```

best process to migrate&#x20;

* spoolsv.exe: print services

| **Process**    | **Typical Path**                   | **Why Migrate Here?**                                                 | **Caveats**                                                |
| -------------- | ---------------------------------- | --------------------------------------------------------------------- | ---------------------------------------------------------- |
| `explorer.exe` | `C:\Windows\explorer.exe`          | User‚Äëland GUI shell; always running under the logged‚Äëin user context  | Loses SYSTEM if you started as a normal user               |
| `lsass.exe`    | `C:\Windows\System32\lsass.exe`    | Local Security Authority; runs as SYSTEM, high privileges             | Crash will blue‚Äëscreen the machine                         |
| `services.exe` | `C:\Windows\System32\services.exe` | Service Control Manager; runs as SYSTEM, very stable                  | Rarely spawns new children ‚Äì less ‚Äúnoise‚Äù                  |
| `svchost.exe`  | `C:\Windows\System32\svchost.exe`  | Generic host for many Windows services; SYSTEM‚Äëlevel, lots of targets | Multiple instances ‚Äì pick one housing non‚Äëcritical service |
| `winlogon.exe` | `C:\Windows\System32\winlogon.exe` | Manages user logons; runs as SYSTEM                                   | If it crashes, user is logged out                          |
| `spoolsv.exe`  | `C:\Windows\System32\spoolsv.exe`  | Print Spooler service; SYSTEM‚Äëlevel, long‚Äëlived                       | Can draw attention if printing unused jobs                 |
| `taskeng.exe`  | `C:\Windows\System32\taskeng.exe`  | Task Scheduler Engine; SYSTEM if scheduled by system                  | May not always run under SYSTEM                            |
| `csrss.exe`    | `C:\Windows\System32\csrss.exe`    | Client/Server Runtime Subsystem; SYSTEM‚Äëlevel                         | Very sensitive‚Äîcrashing it blue‚Äëscreens                    |

### üí° Tips

* **SYSTEM vs. User**: If you need SYSTEM privileges, choose `lsass.exe`, `services.exe` or an `svchost.exe` hosting SYSTEM services.
* **Stability**: GUI processes (`explorer.exe`) can crash if you inject weird payloads; services are generally safer.
* **Stealth**: Blend into normal service activity‚Äîavoid rare or high‚Äëinterest processes.
* **Crash impact**: Crashing a critical process (LSASS, winlogon, csrss) can blue‚Äëscreen the machine and tip off defenders.

## Hashdump

The `hashdump` command will list the content of the SAM database. The SAM (Security Account Manager) database stores user's passwords on Windows systems. These passwords are stored in the NTLM (New Technology LAN Manager) format.

## üîç Search command

The `search` command is useful to locate files with potentially juicy information. In a CTF context, this can be used to quickly find a flag or proof file, while in actual penetration testing engagements, you may need to search for user-generated files or configuration files that may contain password or account information.

```
meterpreter > search -f flag2.txt
Found 1 result...
    c:\Windows\System32\config\flag2.txt (34 bytes)
meterpreter >
```

