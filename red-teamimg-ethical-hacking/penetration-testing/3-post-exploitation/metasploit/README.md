# Metasploit

Open machines terminal&#x20;

```
shell
```

Go back to meterpreter

* ctrl + z to exit
* typing exit

**Linux**&#x20;

opens  better shell

```bash
/bin/bash -i 
```

* -i : interactive shell

**Windows**&#x20;

opens better shell

```
cmd.exe
```

## &#x20;📶 **Sessions Commands**

Send current session to background

```bash
background
```

| Command            | Description                                      | Example         |
| ------------------ | ------------------------------------------------ | --------------- |
| `sessions`         | List all active sessions.                        | `sessions`      |
| `sessions -i <id>` | Interact with a specific session.                | `sessions -i 1` |
| `sessions -k <id>` | Kill a specific session.                         | `sessions -k 1` |
| `sessions -K`      | Kill all sessions.                               | `sessions -K`   |
| `sessions -v`      | List verbose info about sessions.                | `sessions -v`   |
| `sessions -u <id>` | Upgrade a shell to Meterpreter.                  | `sessions -u 2` |
| `interact <id>`    | Interact with a session (same as `sessions -i`). | `interact 1`    |

## 📶Upgrade Session

This commands upgrades to a meterpeter session

```
sessions -u <session_id>
```

```
post/multi/manage/shell_to_meterpreter
```

## Autoroute

### 🔁 What is `autoroute`?

`autoroute` is a **Meterpreter post module** that adds routes to subnets accessible **only from the target machine**, allowing you to pivot through it and reach internal networks.

| Command                                  | Description                    |
| ---------------------------------------- | ------------------------------ |
| `run autoroute`                          | Loads autoroute module         |
| `run autoroute -s <subnet> -n <netmask>` | Adds a route to subnet         |
| `run autoroute -p`                       | Prints current routes          |
| `run autoroute -d <subnet>`              | Deletes a specific route       |
| `route`                                  | View Metasploit's route table  |
| `route add <subnet> <mask> <id>`         | Manually add route via session |

## Migrate

First we use ps command to see running services and choose

For highest privalege we choose **SYSTEM services also we downgrade to lower service with less permision we cant go back up**

{% hint style="warning" %}
Anything under `NT AUTHORITY\SYSTEM` is running as SYSTEM.
{% endhint %}

```
meterpeter> migrate <PID>
```

best process to migrate&#x20;

* spoolsv.exe: print services

| **Process**    | **Typical Path**                   | **Why Migrate Here?**                                                 | **Caveats**                                                |
| -------------- | ---------------------------------- | --------------------------------------------------------------------- | ---------------------------------------------------------- |
| `explorer.exe` | `C:\Windows\explorer.exe`          | User‑land GUI shell; always running under the logged‑in user context  | Loses SYSTEM if you started as a normal user               |
| `lsass.exe`    | `C:\Windows\System32\lsass.exe`    | Local Security Authority; runs as SYSTEM, high privileges             | Crash will blue‑screen the machine                         |
| `services.exe` | `C:\Windows\System32\services.exe` | Service Control Manager; runs as SYSTEM, very stable                  | Rarely spawns new children – less “noise”                  |
| `svchost.exe`  | `C:\Windows\System32\svchost.exe`  | Generic host for many Windows services; SYSTEM‑level, lots of targets | Multiple instances – pick one housing non‑critical service |
| `winlogon.exe` | `C:\Windows\System32\winlogon.exe` | Manages user logons; runs as SYSTEM                                   | If it crashes, user is logged out                          |
| `spoolsv.exe`  | `C:\Windows\System32\spoolsv.exe`  | Print Spooler service; SYSTEM‑level, long‑lived                       | Can draw attention if printing unused jobs                 |
| `taskeng.exe`  | `C:\Windows\System32\taskeng.exe`  | Task Scheduler Engine; SYSTEM if scheduled by system                  | May not always run under SYSTEM                            |
| `csrss.exe`    | `C:\Windows\System32\csrss.exe`    | Client/Server Runtime Subsystem; SYSTEM‑level                         | Very sensitive—crashing it blue‑screens                    |

### 💡 Tips

* **SYSTEM vs. User**: If you need SYSTEM privileges, choose `lsass.exe`, `services.exe` or an `svchost.exe` hosting SYSTEM services.
* **Stability**: GUI processes (`explorer.exe`) can crash if you inject weird payloads; services are generally safer.
* **Stealth**: Blend into normal service activity—avoid rare or high‑interest processes.
* **Crash impact**: Crashing a critical process (LSASS, winlogon, csrss) can blue‑screen the machine and tip off defenders.

## Hashdump

{% content-ref url="../credential-dumping/" %}
[credential-dumping](../credential-dumping/)
{% endcontent-ref %}

## Kiwi/mikikatz

{% content-ref url="../credential-dumping/" %}
[credential-dumping](../credential-dumping/)
{% endcontent-ref %}

## 🔍 Search command

The `search` command is useful to locate files with potentially juicy information. In a CTF context, this can be used to quickly find a flag or proof file, while in actual penetration testing engagements, you may need to search for user-generated files or configuration files that may contain password or account information.

```
meterpreter > search -f flag2.txt
Found 1 result...
    c:\Windows\System32\config\flag2.txt (34 bytes)
meterpreter >
```

## &#x20;getuid

If it says:

* `NT AUTHORITY\SYSTEM` → highest level (even above Administrator).
* `Administrator` or local admin name → high privileges.
* `User` or standard account → low privileges.

## &#x20;sysinfo&#x20;

Command linux`sysinfo`

Command win `systeminfo`

## &#x20;⬆️Privilege escalation

{% content-ref url="../privilege-escalation/" %}
[privilege-escalation](../privilege-escalation/)
{% endcontent-ref %}

## Post modules

🧨 POST-EXPLOITATION MODULES IN METASPLOIT

You can list these yourself in `msfconsole` with:

```bash
show post
```

```
search type:post platform:windows
```

🔧 CATEGORIES + POPULAR MODULES

### 1. 📥 **Gather** – Collect data from the target

**🔹 `post/windows/gather/`**

* `hashdump` – Dump SAM password hashes
* `credentials/windows_autologin` – Get autologin credentials
* `credentials/credential_collector` – Collect creds from multiple sources
* `enum_chrome` – Dump Chrome credentials/history
* `enum_application_patches`
* `enum_logged_on_users`
* `enum_av` – Detect installed antivirus
* `enum_domain_group_users`
* `enum_domain`
* `smart_hashdump` – Safe hash dumping (automatically picks right technique)

**🔹 `post/multi/gather/`**

* `enum_users_history`
* `firefox_creds`
* `skype`
* `thunderbird_creds`

***

### 2. ⚙️ **Manage** – Modify the system or Meterpreter behavior

**🔹 `post/windows/manage/`**

* `migrate` – Move Meterpreter to another process
* `keylog_start` / `keylog_dump` – Start and dump keystrokes
* `enable_rdp`
* `execute`
* `explorer` – Launch explorer.exe for stability
* `schedule_persistence` – Add persistence via scheduled task
* `delete_file`

### 3. 📈 **Escalate** – Elevate privileges on the system

**🔹 `post/windows/escalate/`**

* `ms16_032_secondary_logon_handle_privesc`
* `ms10_092_schelevator`
* `namedpipe_privesc`
* `service_permissions`
* `always_install_elevated`

**🔹 `post/multi/recon/local_exploit_suggester`**

* Suggests local privesc exploits for any platform

### 4. 🔎 **Recon** – Analyze system to plan next steps

**🔹 `post/multi/recon/`**

* `local_exploit_suggester` – Suggests privilege escalation methods
* `whoami` – Get user and domain info
* `netstat` – See open ports and connections

**🔹 `post/windows/recon/`**

* `enum_domain_tokens`
* `enum_ie`
* `enum_shares`
* `resolve_sid`

### 5. 🧠 **Credentials** – Grab passwords and secrets

**🔹 `post/windows/gather/credentials/`**

* `lsass` – Extracts creds from memory (like mimikatz)
* `windows_autologin`
* `token_collector`
* `vnc_passwords`
* `rdp_saved_passwords`

### 6. 🔁 **Persistence** – Maintain access

* `post/windows/manage/schedule_persistence`
* `post/windows/manage/persistence`
* `post/multi/manage/shell_to_meterpreter` – Upgrade shell to meterpreter















