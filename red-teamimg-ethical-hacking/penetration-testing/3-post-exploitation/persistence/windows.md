# Windows

## Metasploit Modules

### &#x20;How to use peristence modules afte deploy

```
use exploit/multi/handler
```

* set the LPORT we used
* set lhost ip or eth1&#x20;

{% hint style="warning" %}
The handler we will keep trying until it gets a connection
{% endhint %}

### Modules

```
exploit/windows/local/persistence
```

* **Purpose**: Sets up full persistence via registry and script.
* **Technique**: Adds a payload (like a reverse shell) to `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`.

{% hint style="warning" %}
Not very reliable requier computer to restart to work
{% endhint %}

⚠️ **Disadvantages of `exploit/windows/local/persistence`**

#### 1. 🧼 **Easily Detectable**

* **Registry keys** (like `Run`) and **scripts** dropped to disk are **well-known** to defenders and security software.
* **AV/EDR solutions** often flag the payloads and registry modifications almost instantly.

#### 2. 🔊 **Noisy Behavior**

* Drops a `.vbs` or `.bat` script to disk and modifies registry.
* File and registry activity creates a lot of **telemetry** (logged by Sysmon, EDRs, Windows Defender).

#### 3. 🪟 **Only Works on Interactive Desktop Sessions**

* Requires a **meterpreter session** running in the **context of an interactive user**.
* Doesn’t work well for SYSTEM sessions or non-interactive shells.

#### 4. 🧍 **Tied to User Account**

* If persistence is set via `HKCU`, it's only for **one user**.
* Logging in as another user won't trigger the payload.

#### 5. 🛡️ **No Obfuscation or Evasion**

* Payload is dropped **as-is**.
* No encoding, encryption, or AV evasion — can be caught by basic signature-based scanners.

#### 6. 🔁 **Creates Redundant Processes**

* Multiple persistence attempts can result in **duplicate tasks or registry keys**, making detection easier.
* No cleanup mechanism by default unless manually removed.

#### 7. 📁 **Static File Paths**

* Drops payloads to default locations (e.g., `C:\Users\Public\`) which are **commonly monitored**.

***

```
exploit/windows/local/persistence_service 
```

#### 📌 **Purpose:**

Creates a **Windows service** that launches a malicious payload (e.g., Meterpreter) **every time the computer starts**.

⚙️ **How It Works**

1. Uploads a **payload executable** (e.g., reverse shell).
2. Registers a **Windows service** that runs that EXE at startup.
3. The service is configured to start **automatically** with the OS (even before a user logs in).

✅ **Advantages**

| Advantage                        | Description                                                                    |
| -------------------------------- | ------------------------------------------------------------------------------ |
| 💻 **Runs before user login**    | Triggered at system boot, not tied to user sessions                            |
| 🔄 **Persistent across reboots** | Survives restart, stays active unless removed                                  |
| 🧑‍🔧 **Runs as SYSTEM**         | If exploited with SYSTEM-level access, the service runs with SYSTEM privileges |
| 🛠️ **Stealthier than Run key**  | Services are harder to spot than registry keys or VBS scripts                  |
| 👥 **Affects all users**         | Not limited to a single user like `HKCU` registry keys                         |

❌ **Disadvantages / Detection Risks**

| Disadvantage                            | Description                                                   |
| --------------------------------------- | ------------------------------------------------------------- |
| 🛡️ **Highly detectable**               | Creating a rogue service can trigger AV/EDR alerts            |
| 📁 **Drops EXE to disk**                | Payload stored in a known location (e.g., `C:\Windows\Temp\`) |
| 📝 **Service name may look suspicious** | Can show up in `services.msc` or `sc query`                   |
| 🧹 **Manual cleanup needed**            | Doesn’t remove itself unless you script it to do so           |

✅ **Good (Stealthy) SERVICE\_NAME**

| Service Name      | Display Name                  | Why It Works                        |
| ----------------- | ----------------------------- | ----------------------------------- |
| `WinUpdateSvc`    | Windows Update Helper         | Mimics Windows Update               |
| `W32TimeSvc`      | Windows Time Sync             | Close to real `W32Time`             |
| `SysTaskMgr`      | System Task Manager           | Sounds legit, mimics system utility |
| `SecurityHealth`  | Windows Security Monitor      | Looks like built-in Defender        |
| `SpoolSubSystem`  | Print Spooler Support Service | Sounds like legit spooler           |
| `LSMHelper`       | Local Session Manager Helper  | Mimics real `LSM`                   |
| `WinLogonAssist`  | Windows Logon Support         | Close to `Winlogon`                 |
| `RPCSSHost`       | Remote Procedure Call Helper  | Close to real `RPCSS`               |
| `ShellHostHelper` | Windows Shell Integration     | Ambiguous and tech-sounding         |
| `IntelNetService` | Intel Network Service         | Blends with drivers/OEM stuff       |

***

## &#x20;Enabling RDP

```
post/windows/manage/enable_rdp
```

### ✅ **Purpose**:

This module **enables Remote Desktop** on a compromised Windows machine so you can connect using tools like **Remote Desktop Connection (mstsc)**.

### 🧠 **How It Works**

The module:

* Enables RDP via registry edits.
* Configures the system to **allow remote desktop connections**.
* Starts the RDP service if it’s not already running.
* Optionally **adds a user to the Remote Desktop Users group**.

### ⚠️ **Considerations**

| Risk                         | Description                                                                           |
| ---------------------------- | ------------------------------------------------------------------------------------- |
| 🔊 **Loud**                  | Enabling RDP and creating users may be logged (especially in enterprise environments) |
| 🔒 **Firewall**              | Port 3389 must be open. May need to open it manually via `netsh`.                     |
| 👁️‍🗨️ **EDR/AV detection** | These changes can trigger alerts if monitored                                         |

### 🧪 Want to Manually Enable RDP?

```
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
netsh advfirewall firewall set rule group="remote desktop" new enable=yes
```

Change admin password(NOT Recommend)

```bash
net user <name> <newpass>
```

### Connecting after deploiyng

```
xfreerdp /u:NAME /p:PASS
```

## &#x20;Via Services

