# AV Evasion & Obfuscation

### üß† 1. **What is Evasion?**

**Evasion** is the technique of **avoiding detection** by security systems like antivirus (AV), EDR (Endpoint Detection & Response), firewalls, and intrusion detection systems (IDS).

#### üîπ Types of Evasion Techniques:

| Type                   | Description                                                       | Example                                               |
| ---------------------- | ----------------------------------------------------------------- | ----------------------------------------------------- |
| **Signature Evasion**  | Avoiding detection by changing how known malicious code looks     | Encrypting or encoding payloads                       |
| **Behavioral Evasion** | Avoiding detection based on how malware behaves                   | Delayed execution, checking if debugger is present    |
| **Static Evasion**     | Altering code structure to avoid detection at rest (on disk)      | Obfuscation, packing, polymorphism                    |
| **Dynamic Evasion**    | Altering behavior at runtime to avoid being caught by sandbox/EDR | Environment checks, staged payloads                   |
| **Network Evasion**    | Hiding malicious traffic                                          | C2 over DNS, HTTPS, domain fronting                   |
| **Process Evasion**    | Avoiding suspicious parent-child process relationships            | Spawning from trusted binaries (e.g., `rundll32.exe`) |
| **In-Memory Evasion**  | Operating fully in memory to avoid writing to disk                | Reflective DLL injection, `mmap` injection            |

### üîç 2. **What is Obfuscation?**

**Obfuscation** is the process of **making code or commands harder to understand**, both to humans and security software. It's commonly used to **evade detection**.

#### üîπ Types of Obfuscation:

| Type                         | Description                                                         | Example                               |
| ---------------------------- | ------------------------------------------------------------------- | ------------------------------------- |
| **Code Obfuscation**         | Renaming functions/variables, changing logic structure              | `var a=1` ‚Üí `var zq1=1`               |
| **String Obfuscation**       | Encoding or encrypting strings used in malware                      | `"powershell"` ‚Üí `"p"+"ower"+"shell"` |
| **Command Obfuscation**      | Altering CLI commands to look different while doing the same thing  | `-enc` base64, or using aliases       |
| **PowerShell Obfuscation**   | Changing script structure, using functions like `Invoke-Expression` | `IEX` instead of direct execution     |
| **Control Flow Obfuscation** | Rearranging code execution paths to confuse analysis tools          | Adding fake branches or dead code     |

### üß¨ 3. **What is Shellcode Injection?**

**Shellcode injection** refers to **injecting malicious code (shellcode)** into a process‚Äôs memory so it can execute without writing to disk.

#### üîπ Types of Shellcode Injection:

| Technique                    | Description                                                                        | Tools/Examples                         |
| ---------------------------- | ---------------------------------------------------------------------------------- | -------------------------------------- |
| **Remote Thread Injection**  | Allocating memory in another process and creating a thread to run shellcode        | `VirtualAllocEx`, `CreateRemoteThread` |
| **Reflective DLL Injection** | Load a DLL entirely from memory, bypassing disk writes                             | Metasploit ReflectiveLoader            |
| **Process Hollowing**        | Start a legitimate process, unmap its memory, inject shellcode                     | Often used with `svchost.exe`          |
| **DLL Sideloading**          | Load a malicious DLL in place of a legitimate one                                  | Abuse misconfigured search paths       |
| **Manual Mapping**           | Inject a PE file manually into memory without using the OS loader                  | Advanced EDR bypass                    |
| **APC Injection**            | Queue a shellcode execution inside a target thread via Asynchronous Procedure Call | Often used with `NtQueueApcThread`     |
| **Thread Context Hijacking** | Suspend a thread, hijack its context (registers) to point to shellcode             | Deep in-memory injection technique     |

## üí£ What Happens When Meterpreter Is:

### 1. ‚ùå Just Sitting on the Desktop (Static / At Rest)

This is when:

* The `.exe` or `.dll` file is **not running**
* It‚Äôs just a file on disk

#### üîç AV Detection Type: **Static File Scanning**

* Antivirus scans files on disk.
* It looks for:
  * **Known signatures** (patterns in code)
  * **Strings** (like `"metsvc"`, `"reverse_tcp"`, or `"cmd.exe"`)
  * **PE structure anomalies**
  * Suspicious imports (`VirtualAlloc`, `CreateThread`, etc.)
  * Known Meterpreter payloads (e.g., reverse shell patterns)

‚úÖ If it's a known payload **and not obfuscated**, most AVs will catch it here.

***

### 2. ‚öôÔ∏è When You Run It (Dynamic / At Execution)

Now the payload is **executing**.

#### üîç AV/EDR Detection Type: **Behavioral + Memory Monitoring**

Once running, AV/EDR can:

* **Monitor API calls** (like `CreateRemoteThread`, `VirtualAllocEx`, `WSASocket`)
* Check what process is making a **network connection**
* Scan the **memory** of processes
* Detect Meterpreter‚Äôs **stager/stage loading behavior**
* Flag **process hollowing**, **DLL injection**, or **suspicious threads**

üß† This is where **EDRs (like SentinelOne, CrowdStrike, Defender ATP)** shine ‚Äî they watch behavior, not just signatures.

üö® Even if you obfuscate the file on disk, a **behavioral EDR** may detect what it **does when it runs.**

***

### 2. ‚öôÔ∏è When You Run It (Dynamic / At Execution)

Now the payload is **executing**.

#### üîç AV/EDR Detection Type: **Behavioral + Memory Monitoring**

Once running, AV/EDR can:

* **Monitor API calls** (like `CreateRemoteThread`, `VirtualAllocEx`, `WSASocket`)
* Check what process is making a **network connection**
* Scan the **memory** of processes
* Detect Meterpreter‚Äôs **stager/stage loading behavior**
* Flag **process hollowing**, **DLL injection**, or **suspicious threads**

üß† This is where **EDRs (like SentinelOne, CrowdStrike, Defender ATP)** shine ‚Äî they watch behavior, not just signatures.

üö® Even if you obfuscate the file on disk, a **behavioral EDR** may detect what it **does when it runs.**

***

### 3. üß¨ When Injected Into Another Process (e.g., `notepad.exe`)

It:

* Spawns or migrates into another process
* Injects shellcode or a DLL into that process (using `CreateRemoteThread`, `WriteProcessMemory`, etc.)

#### üîç AV/EDR Detection Type: **Process Injection + Memory Scanning**

EDR may:

* Notice that `notepad.exe` now contains **unexpected memory regions marked executable (RWX)**
* Detect **unusual threads** inside `notepad.exe`
* Alert on **code injection patterns**
* Catch **suspicious syscall chains**

‚úÖ This bypasses weak AV\
‚ö†Ô∏è But **modern EDRs catch this unless you use obfuscation + syscall tricks**

***

## üîê Why Fileless Attacks Work Better

Injecting into memory:

* Avoids the disk completely
* Makes payload **harder to trace** (especially with obfuscation or encryption)
* Can live **inside trusted processes** (e.g., `explorer.exe`, `svchost.exe`)

But this only works if:

* You avoid **obvious API calls**
* You evade **memory scanners**
* You bypass **behavioral logging**
